version: '3.8'

services:
  # Backend API
  netguard-backend:
    build:
      context: ..
      dockerfile: deployment/Dockerfile.arm64
    image: sentinai-netguard:arm64
    container_name: netguard-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - MONGO_URI=mongodb://netguard-db:27017
      - OCI_CONFIG_PROFILE=DEFAULT
      # Map other env vars here or use env_file
    env_file:
      - ../.env
    depends_on:
      - netguard-db
    networks:
      - oci_net
    # Resource Limits for Free Tier (Max 24GB, but let's be efficient)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G

  # Database (MongoDB 6.0 is ARM64 compatible)
  netguard-db:
    image: mongo:6.0
    container_name: netguard-db
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    networks:
      - oci_net
    # Critical: Limit Mongo Cache to avoid OOM on smaller instances
    command: [ "mongod", "--wiredTigerCacheSizeGB", "1" ]
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 2G

networks:
  oci_net:
    driver: bridge

volumes:
  mongo_data:
